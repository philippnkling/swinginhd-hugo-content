name: Process and Trigger site rebuild

on:
  push:
    branches: [main]
    paths:
      - 'post/**'
      - 'img/**'

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout content repository
        uses: actions/checkout@v4

      - name: Prepare Python environment
        run: sudo apt-get update && sudo apt-get install -y python3-yaml

      - name: Process posts
        run: |
          mkdir -p post_processed
          for file in post/*.md; do
            echo "üîç Processing $file ..."
            filename=$(basename "$file")
            name="${filename%.md}"

            # Extract image reference from front matter (if any)
            image=$(grep -E '^image:' "$file" | sed -E 's/image:\s*//')

            if [[ -n "$image" && -f "img/$image" ]]; then
              echo "üì∏ Found image '$image' for $filename"

              mkdir -p "post_processed/$name"
              cp "$file" "post_processed/$name/index.md"
              cp "img/$image" "post_processed/$name/$image"
            else
              echo "‚ÑπÔ∏è  No image found or referenced for $filename"
              cp "$file" "post_processed/$filename"
            fi
          done

      - name: Display processed structure (debug)
        run: tree post_processed || find post_processed

      - name: Upload processed content artifact
        uses: actions/upload-artifact@v4
        with:
          name: processed-posts
          path: post_processed/

      # ‚úÖ Trigger the website repo to rebuild
      - name: Trigger site rebuild
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.SITE_REPO_TOKEN }}
          repository: philippnkling/swinginhd-hugo
          event-type: content-updated

